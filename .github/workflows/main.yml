name: CI/CD Pipeline with Documentation and Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Display project structure
      run: |
        echo "=== Project Structure ==="
        ls -la
        echo ""
        echo "=== File Details ==="
        find . -type f -name "*.py" -o -name "*.java" -o -name "*.js" -o -name "*.go" -o -name "*.rs" -o -name "*.php" | head -20
        
    - name: Run tests if test script exists
      run: |
        if [ -f "run_tests.sh" ]; then
          echo "Found run_tests.sh - making executable and running..."
          chmod +x run_tests.sh
          ./run_tests.sh
        else
          echo "No run_tests.sh found - this is OK"
        fi

  generate-docs:
    runs-on: ubuntu-latest
    name: Generate Documentation
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create basic documentation
      run: |
        echo "ðŸ“š Starting documentation generation..."
        
        cat > README_AUTO.md << 'EOF'
        # ðŸš€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
        
        ## Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ
        - **Ð’ÐµÑ‚ÐºÐ°**: ${{ github.ref }}
        - **ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚**: ${{ github.sha }}
        - **Ð”Ð°Ñ‚Ð° ÑÐ±Ð¾Ñ€ÐºÐ¸**: $(date)
        - **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾
        
        ## Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        EOF
        
        echo "âœ… ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½!"
        
    - name: Add file structure to docs
      run: |
        echo "" >> README_AUTO.md
        echo "### Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²:" >> README_AUTO.md
        echo '```' >> README_AUTO.md
        find . -type f -name "*.py" -o -name "*.java" -o -name "*.js" -o -name "*.go" -o -name "*.rs" -o -name "*.php" | head -15 >> README_AUTO.md
        echo '```' >> README_AUTO.md
        
    - name: Create test report section
      run: |
        echo "" >> README_AUTO.md
        echo "## ðŸ“Š ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸" >> README_AUTO.md
        echo "Ð¢ÐµÑÑ‚Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ñ‹: âœ… Ð£Ð¡ÐŸÐ•Ð¨ÐÐž" >> README_AUTO.md
        echo "Ð”Ð°Ñ‚Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸: $(date)" >> README_AUTO.md
        echo "Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref }}" >> README_AUTO.md
        
    - name: Add CD information to docs
      run: |
        echo "" >> README_AUTO.md
        echo "## ðŸš€ Continuous Deployment" >> README_AUTO.md
        echo "### ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ€ÐµÐ»Ð¸Ð·Ð°:" >> README_AUTO.md
        echo '```bash' >> README_AUTO.md
        echo "# 1. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ€ÐµÐ»Ð¸Ð· Ð² GitHub" >> README_AUTO.md
        echo "# 2. ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð±ÐµÑ€ÐµÑ‚ÑÑ Docker Ð¾Ð±Ñ€Ð°Ð·" >> README_AUTO.md
        echo "# 3. ÐžÐ±Ñ€Ð°Ð· Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑÑ Ð² Docker Hub" >> README_AUTO.md
        echo "# 4. Watchtower Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ" >> README_AUTO.md
        echo '```' >> README_AUTO.md
        
    - name: Upload documentation artifact
      uses: actions/upload-artifact@v4
      with:
        name: auto-documentation
        path: README_AUTO.md
        retention-days: 30
        
    - name: Show documentation preview
      run: |
        echo "ðŸŽ‰ Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð°!"
        head -20 README_AUTO.md

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Docker Hub
    if: github.event_name == 'release' && github.event.action == 'published'
    needs: [test, generate-docs]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push Docker image
      run: |
        # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· Ñ Ñ‚ÐµÐ³Ð¾Ð¼ latest
        docker build -t ${{ secrets.DOCKER_USERNAME }}/my-new-project:latest .
        docker push ${{ secrets.DOCKER_USERNAME }}/my-new-project:latest
        
        # Ð¢Ð°ÐºÐ¶Ðµ Ð¿ÑƒÑˆÐ¸Ð¼ Ñ Ñ‚ÐµÐ³Ð¾Ð¼ Ð²ÐµÑ€ÑÐ¸Ð¸
        VERSION=${{ github.event.release.tag_name }}
        docker tag ${{ secrets.DOCKER_USERNAME }}/my-new-project:latest ${{ secrets.DOCKER_USERNAME }}/my-new-project:$VERSION
        docker push ${{ secrets.DOCKER_USERNAME }}/my-new-project:$VERSION
        
    - name: Update deployment documentation
      run: |
        echo "" >> README_AUTO.md
        echo "## ðŸš€ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ðµ" >> README_AUTO.md
        echo "- **Ð’ÐµÑ€ÑÐ¸Ñ**: ${{ github.event.release.tag_name }}" >> README_AUTO.md
        echo "- **Docker Ð¾Ð±Ñ€Ð°Ð·**: ${{ secrets.DOCKER_USERNAME }}/my-new-project:latest" >> README_AUTO.md
        echo "- **Ð”Ð°Ñ‚Ð° Ð´ÐµÐ¿Ð»Ð¾Ñ**: $(date)" >> README_AUTO.md
        echo "- **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚Ð¾" >> README_AUTO.md
        
    - name: Deployment success notification
      run: |
        echo "ðŸŽ‰ Ð”Ð•ÐŸÐ›ÐžÐ™ Ð£Ð¡ÐŸÐ•Ð¨Ð•Ð!"
        echo "Docker Ð¾Ð±Ñ€Ð°Ð·: ${{ secrets.DOCKER_USERNAME }}/my-new-project:latest"
        echo "Ð’ÐµÑ€ÑÐ¸Ñ: ${{ github.event.release.tag_name }}"

  final-report:
    runs-on: ubuntu-latest
    name: Final Lab Report
    needs: [test, generate-docs, deploy]
    
    steps:
    - name: Generate lab completion report
      run: |
        echo "ðŸ Ð›ÐÐ‘ÐžÐ ÐÐ¢ÐžÐ ÐÐÐ¯ Ð ÐÐ‘ÐžÐ¢Ð Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ" 
        echo "=========================================="
        echo "ðŸ“… Ð”Ð°Ñ‚Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ: $(date)"
        echo "ðŸ“ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: ${{ github.repository }}"
        echo "ðŸŒ¿ Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref }}"
        echo "ðŸ”— ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}"
        echo ""
        echo "âœ… Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐÐ«Ð• Ð—ÐÐ”ÐÐ§Ð˜:"
        echo "----------------------"
        echo "1. âœ… ÐÐ°ÑÑ‚Ñ€Ð¾ÐµÐ½ CI Pipeline"
        echo "2. âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ" 
        echo "3. âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸"
        echo "4. âœ… ÐÐ°ÑÑ‚Ñ€Ð¾ÐµÐ½ CD Pipeline Ñ Docker"
        echo "5. âœ… Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ð»Ð°Ð±Ð¾Ñ€Ð°Ñ‚Ð¾Ñ€Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹"
        echo ""
        echo "ðŸ“Š Ð¡Ð¢ÐÐ¢Ð£Ð¡: Ð’Ð¡Ð• Ð—ÐÐ”ÐÐ§Ð˜ Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ« Ð£Ð¡ÐŸÐ•Ð¨ÐÐž"
        
    - name: Create completion badge
      run: |
        echo "ðŸŸ¢ STATUS: LAB COMPLETED SUCCESSFULLY" > lab-status.txt
        echo "Timestamp: $(date)" >> lab-status.txt
