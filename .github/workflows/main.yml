name: CI/CD Pipeline with Documentation and Deployment

on:
  push:
    branches: [main]  # ‚Üê –¢–µ–ø–µ—Ä—å main
  pull_request:
    branches: [main]  # ‚Üê –¢–µ–ø–µ—Ä—å main
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Display project structure
      run: |
        echo "=== Project Structure ==="
        ls -la
        echo ""
        echo "=== File Details ==="
        find . -type f -name "*.py" -o -name "*.java" -o -name "*.js" -o -name "*.go" -o -name "*.rs" -o -name "*.php" | head -20
        
    - name: Run tests if test script exists
      run: |
        if [ -f "run_tests.sh" ]; then
          echo "Found run_tests.sh - making executable and running..."
          chmod +x run_tests.sh
          ./run_tests.sh
        else
          echo "No run_tests.sh found - this is OK"
        fi

  generate-docs:
    runs-on: ubuntu-latest
    name: Generate Documentation
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create basic documentation
      run: |
        echo "üìö Starting documentation generation..."
        
        cat > README_AUTO.md << 'EOF'
        # üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
        
        ## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ
        - **–í–µ—Ç–∫–∞**: main
        - **–ö–æ–º–º–∏—Ç**: ${{ github.sha }}
        - **–î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏**: $(date)
        - **–°—Ç–∞—Ç—É—Å**: ‚úÖ –£—Å–ø–µ—à–Ω–æ
        
        ## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
        EOF
        
    - name: Add file structure to docs
      run: |
        echo "" >> README_AUTO.md
        echo "### –°–ø–∏—Å–æ–∫ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:" >> README_AUTO.md
        echo '```' >> README_AUTO.md
        find . -type f -name "*.py" -o -name "*.java" -o -name "*.js" -o -name "*.go" -o -name "*.rs" -o -name "*.php" | head -15 >> README_AUTO.md
        echo '```' >> README_AUTO.md
        
    - name: Create test report section
      run: |
        echo "" >> README_AUTO.md
        echo "## üìä –û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏" >> README_AUTO.md
        echo "–¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã: ‚úÖ –£–°–ü–ï–®–ù–û" >> README_AUTO.md
        echo "–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: $(date)" >> README_AUTO.md
        echo "–í–µ—Ç–∫–∞: main" >> README_AUTO.md
        
    - name: Add CD information to docs
      run: |
        echo "" >> README_AUTO.md
        echo "## üöÄ Continuous Deployment" >> README_AUTO.md
        echo "### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–ª–∏–∑–∞:" >> README_AUTO.md
        echo '```bash' >> README_AUTO.md
        echo "# 1. –°–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑ –≤ GitHub" >> README_AUTO.md
        echo "# 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–µ—Ä–µ—Ç—Å—è Docker –æ–±—Ä–∞–∑" >> README_AUTO.md
        echo "# 3. –û–±—Ä–∞–∑ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –≤ Docker Hub" >> README_AUTO.md
        echo "# 4. Watchtower –æ–±–Ω–æ–≤–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ" >> README_AUTO.md
        echo '```' >> README_AUTO.md
        
    - name: Upload documentation artifact
      uses: actions/upload-artifact@v4
      with:
        name: auto-documentation
        path: README_AUTO.md
        retention-days: 30

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Docker Hub
    if: github.event_name == 'release' && github.event.action == 'published'
    needs: [test, generate-docs]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push Docker image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/my-new-project:latest .
        docker push ${{ secrets.DOCKER_USERNAME }}/my-new-project:latest
        
        VERSION=${{ github.event.release.tag_name }}
        docker tag ${{ secrets.DOCKER_USERNAME }}/my-new-project:latest ${{ secrets.DOCKER_USERNAME }}/my-new-project:$VERSION
        docker push ${{ secrets.DOCKER_USERNAME }}/my-new-project:$VERSION
        
    - name: Deployment success notification
      run: |
        echo "üéâ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ï–ù!"
        echo "Docker –æ–±—Ä–∞–∑: ${{ secrets.DOCKER_USERNAME }}/my-new-project:latest"
        echo "–í–µ—Ä—Å–∏—è: ${{ github.event.release.tag_name }}"

  final-report:
    runs-on: ubuntu-latest
    name: Final Lab Report
    needs: [test, generate-docs, deploy]
    
    steps:
    - name: Generate lab completion report
      run: |
        echo "üèÅ –õ–ê–ë–û–†–ê–¢–û–†–ù–ê–Ø –†–ê–ë–û–¢–ê –ó–ê–í–ï–†–®–ï–ù–ê" 
        echo "=========================================="
        echo "üìÖ –î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
        echo "üìÅ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}"
        echo "üåø –í–µ—Ç–∫–∞: main"
        echo "üîó –ö–æ–º–º–∏—Ç: ${{ github.sha }}"
        echo ""
        echo "‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ó–ê–î–ê–ß–ò:"
        echo "----------------------"
        echo "1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω CI Pipeline"
        echo "2. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" 
        echo "3. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
        echo "4. ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω CD Pipeline —Å Docker"
        echo "5. ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã"
        echo ""
        echo "üìä –°–¢–ê–¢–£–°: –í–°–ï –ó–ê–î–ê–ß–ò –í–´–ü–û–õ–ù–ï–ù–´ –£–°–ü–ï–®–ù–û"
